<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Paris Sunlight Map</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
  html, body { margin:0; padding:0; height:100%; }
  #map { height: 100%; width: 100%; }
  #timeControl {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255,255,255,0.9);
    padding: 8px 12px;
    border-radius: 8px;
    font-family: sans-serif;
    z-index: 1000;
  }
</style>
</head>
<body>

<div id="map"></div>
<div id="timeControl">
  Hour: <span id="timeLabel">12:00</span>
  <input type="range" id="timeSlider" min="0" max="23" value="12">
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<!-- SunCalc JS -->
<script src="https://cdn.jsdelivr.net/npm/suncalc@1.9.0/suncalc.js"></script>
<!-- Turf.js -->
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<!-- Your main script -->
<script>
// ------------------------
// Paris Sunlight Map Script
// ------------------------
let map, streetData=[], buildingData=[];
let streetLayer, buildingLayer;

// Helper: UTC date for slider
function getDateForHour(hour){
  const d=new Date();
  return new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate(),hour,0,0));
}

// Fetch OSM streets/buildings
async function fetchData(lat,lon){
  const query=`[out:json][timeout:25];(
    way(around:300,${lat},${lon})["highway"];
    way(around:300,${lat},${lon})["building"];
  );out geom tags;`;
  const url="https://overpass-api.de/api/interpreter?data="+encodeURIComponent(query);
  const res=await fetch(url);
  const data=await res.json();
  return data.elements;
}

// Draw streets (lit only)
function drawStreets(lat,lon,hour){
  if(streetLayer) streetLayer.clearLayers();
  streetLayer=L.layerGroup().addTo(map);

  const now=getDateForHour(hour);
  const sunPos=SunCalc.getPosition(now,lat,lon);
  const azimuthDeg=(sunPos.azimuth*180/Math.PI+180)%360;
  const altDeg=sunPos.altitude*180/Math.PI;
  if(altDeg<=0) return;

  const roadWidth=6; // meters

  streetData.forEach(way=>{
    if(!way.tags) return;
    if(!['primary','secondary','tertiary','residential'].includes(way.tags.highway)) return;
    if(!way.geometry || way.geometry.length<2) return;

    const latlngs=way.geometry.map(pt=>[pt.lat,pt.lon]);
    for(let i=0;i<latlngs.length-1;i++){
      const p1=latlngs[i], p2=latlngs[i+1];
      const dx=p2[1]-p1[1], dy=p2[0]-p1[0];
      const angle=(Math.atan2(dx,dy)*180/Math.PI+360)%360;
      const diff=Math.abs(angle-azimuthDeg);
      const minDiff=Math.min(diff,360-diff);
      if(minDiff<20){
        const segLen=Math.sqrt(dx*dx+dy*dy);
        const offsetLat=(roadWidth/110540)*(dx/segLen);
        const offsetLon=(roadWidth/111320)*(-dy/segLen);
        const quad=[
          [p1[0]+offsetLat,p1[1]+offsetLon],
          [p2[0]+offsetLat,p2[1]+offsetLon],
          [p2[0]-offsetLat,p2[1]-offsetLon],
          [p1[0]-offsetLat,p1[1]-offsetLon]
        ];
        L.polygon(quad,{color:"none",fillColor:"gold",fillOpacity:0.7,weight:0}).addTo(streetLayer);
      }
    }
  });
}

// Draw buildings (shadows transparent)
function drawBuildings(lat,lon,hour){
  if(buildingLayer) buildingLayer.clearLayers();
  buildingLayer=L.layerGroup().addTo(map);

  const now=getDateForHour(hour);
  const sunPos=SunCalc.getPosition(now,lat,lon);
  const alt=sunPos.altitude;
  if(alt<=0) return;

  buildingData.forEach(b=>{
    if(!b.geometry || b.geometry.length<3) return;
    const footprint=b.geometry.map(pt=>[pt.lat,pt.lon]);
    L.polygon(footprint,{color:"#555",fillColor:"#999",fillOpacity:0.6,weight:1}).addTo(buildingLayer);
  });
}

// Update scene
function updateScene(lat,lon,hour){
  drawStreets(lat,lon,hour);
  drawBuildings(lat,lon,hour);
}

// Fetch new data
async function updateData(lat,lon,hour){
  const elements=await fetchData(lat,lon);
  streetData=elements.filter(e=>e.tags&&e.tags.highway);
  buildingData=elements.filter(e=>e.tags&&e.tags.building&&e.geometry.length>=3);
  updateScene(lat,lon,hour);
}

// Initialize map
async function initMap(){
  const lat=48.8566, lon=2.3522;
  map=L.map('map').setView([lat,lon],17);

  // Minimalist Carto tiles
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{
    attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>',
    subdomains:'abcd',maxZoom:19
  }).addTo(map);

  await updateData(lat,lon,12);

  map.on("click", async(e)=>{
    const hour=parseInt(document.getElementById("timeSlider").value);
    await updateData(e.latlng.lat,e.latlng.lng,hour);
  });

  const slider=document.getElementById("timeSlider");
  const label=document.getElementById("timeLabel");
  slider.addEventListener("input",()=>{
    const hour=parseInt(slider.value,10);
    const localTime=getDateForHour(hour);
    label.textContent=localTime.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    updateScene(map.getCenter().lat,map.getCenter().lng,hour);
  });
}

initMap();
</script>

</body>
</html>
